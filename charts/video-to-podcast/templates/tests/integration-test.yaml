{{/*
Simplified integration test for video-to-podcast Helm chart.
Tests that the UI can communicate with the API using the configured service URL.
*/}}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "video-to-podcast.fullname" . }}-integration-test"
  labels:
    {{- include "video-to-podcast.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "3"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  restartPolicy: Never
  containers:
  - name: integration-test
    image: curlimages/curl:8.4.0
    imagePullPolicy: IfNotPresent
    command: ["/bin/sh", "-c"]
    args:
      - |
        set -ex

        echo "=== Video-to-Podcast Integration Test ==="

        # The API URL the UI is configured to use
        CONFIGURED_API_URL="{{ .Values.ui.config.api.baseUrl | default (include "video-to-podcast.api.url" .) }}"
        
        # Append the health check path
        API_HEALTH_URL="${CONFIGURED_API_URL}{{ .Values.api.healthCheck.path }}"

        echo "--> Testing UI to API connectivity..."
        echo "    API URL (from UI's perspective): ${API_HEALTH_URL}"

        # This test simulates the UI making a call to the API.
        # It verifies that the service name resolution and networking are correct from
        # a pod within the cluster.
        curl -v --fail --connect-timeout 15 "${API_HEALTH_URL}"

        echo "ðŸŽ‰ Integration test passed: UI can successfully communicate with the API!"
    resources:
      limits:
        memory: 128Mi
        cpu: 200m
      requests:
        memory: 64Mi
        cpu: 100m
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
        - ALL
      readOnlyRootFilesystem: true
      runAsNonRoot: true
      runAsUser: 65534
      runAsGroup: 65534
  securityContext:
    runAsNonRoot: true
    runAsUser: 65534
    runAsGroup: 65534
    fsGroup: 65534
