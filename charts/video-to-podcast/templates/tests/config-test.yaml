{{/*
Simplified configuration validation test for video-to-podcast Helm chart.
Tests that the API and UI services are running and accessible via their health check endpoints.
*/}}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "video-to-podcast.fullname" . }}-config-test"
  labels:
    {{- include "video-to-podcast.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "2"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  restartPolicy: Never
  containers:
  - name: config-test
    image: curlimages/curl:8.4.0
    imagePullPolicy: IfNotPresent
    command: ["/bin/sh", "-c"]
    args:
      - |
        set -ex

        echo "=== Video-to-Podcast Configuration Test ==="

        API_URL="http://{{ include "video-to-podcast.api.serviceName" . }}:{{ .Values.api.service.port }}{{ .Values.api.healthCheck.path }}"
        UI_URL="http://{{ include "video-to-podcast.ui.serviceName" . }}:{{ .Values.ui.service.port }}{{ .Values.ui.healthCheck.path }}"

        echo "--> Checking API service at: ${API_URL}"
        curl -v --fail --connect-timeout 15 "${API_URL}"

        echo "--> Checking UI service at: ${UI_URL}"
        curl -v --fail --connect-timeout 15 "${UI_URL}"

        echo "ðŸŽ‰ Configuration test passed!"
    resources:
      limits:
        memory: 128Mi
        cpu: 200m
      requests:
        memory: 64Mi
        cpu: 100m
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
        - ALL
      readOnlyRootFilesystem: true
      runAsNonRoot: true
      runAsUser: 65534
      runAsGroup: 65534
  securityContext:
    runAsNonRoot: true
    runAsUser: 65534
    runAsGroup: 65534
    fsGroup: 65534
